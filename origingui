package com.emperium.neoporiumscanner;

import net.minecraft.client.gui.screen.Screen;
import net.minecraft.client.gui.widget.*;
import net.minecraft.text.Text;
import net.minecraft.client.gui.DrawContext;

import java.util.*;

public class AdvancedGuiScreen extends Screen {
    private TextFieldWidget minYField;
    private TextFieldWidget maxYField;
    private TextFieldWidget singleYField;
    private TextFieldWidget radiusField;
    private TextFieldWidget chunksField;
    private CyclingButtonWidget<String> profileSelector;
    private CyclingButtonWidget<Boolean> scanModeSelector;
    private ButtonWidget blockSelectionButton;
    private ButtonWidget espSettingsButton;
    private ButtonWidget quickScanButton;
    private ButtonWidget clearResultsButton;
    private ButtonWidget saveButton;
    private ButtonWidget autoToggleButton;
    private ButtonWidget espToggleButton;
    private boolean useYRange = true;
    
    public AdvancedGuiScreen() {
        super(Text.literal("Advanced Scanner Config"));
    }
    
    @Override
    protected void init() {
        super.init();
        
        AdvancedScanner.init();
        AdvancedScanner.ScanProfile profile = AdvancedScanner.getCurrentProfile();
        useYRange = profile.useYRange;
        
        // Initialize ESP system if not already
        if (!WallRayRenderer.isESPEnabled()) {
            try {
                WallRayRenderer.init();
                System.out.println("[Neoporium] ESP system initialized from GUI");
            } catch (Exception e) {
                System.err.println("[Neoporium] Failed to initialize ESP: " + e.getMessage());
            }
        }
        
        int centerX = this.width / 2;
        int startY = 40;
        int spacing = 25;
        
        // Title
        this.addDrawableChild(ButtonWidget.builder(
            Text.literal("§6§lAdvanced Neoporium Scanner"),
            button -> {}
        ).dimensions(centerX - 150, 10, 300, 20).build()).active = false;
        
        // Profile selector
        List<String> profileNames = new ArrayList<>(AdvancedScanner.getProfiles().keySet());
        this.profileSelector = CyclingButtonWidget.<String>builder(profileName -> 
            Text.of(profileName))
            .values(profileNames)
            .initially(profile.name)
            .build(centerX - 150, startY, 300, 20,
                Text.literal("Scan Profile"),
                (button, profileName) -> {
                    AdvancedScanner.setCurrentProfile(profileName);
                    updateFields();
                    updateBlockSelectionButton();
                });
        this.addDrawableChild(this.profileSelector);
        
        // Scan mode selector (Radius vs Chunks)
        this.scanModeSelector = CyclingButtonWidget.<Boolean>builder(mode -> 
            Text.of(mode ? "Chunks Mode" : "Radius Mode"))
            .values(Arrays.asList(false, true)) // false = radius mode, true = chunks mode
            .initially(profile.useChunksMode)
            .build(centerX - 150, startY + spacing, 300, 20,
                Text.literal("Scan Mode"),
                (button, useChunksMode) -> {
                    profile.useChunksMode = useChunksMode;
                    updateFieldVisibility();
                });
        this.addDrawableChild(this.scanModeSelector);
        
        // Y Range vs Single Y toggle
        this.addDrawableChild(CyclingButtonWidget.onOffBuilder(useYRange)
            .build(centerX - 150, startY + spacing * 2, 300, 20,
                Text.literal("Use Y Range (vs Single Y)"),
                (button, scanRange) -> {
                    useYRange = scanRange;
                    profile.useYRange = scanRange;
                    updateFieldVisibility();
                })
        );
        
        // Y Range fields
        this.minYField = new TextFieldWidget(
            this.textRenderer, centerX - 150, startY + spacing * 3,
            145, 20, Text.literal("Min Y")
        );
        this.minYField.setText(String.valueOf(profile.minY));
        this.addDrawableChild(this.minYField);
        
        this.maxYField = new TextFieldWidget(
            this.textRenderer, centerX + 5, startY + spacing * 3,
            145, 20, Text.literal("Max Y")
        );
        this.maxYField.setText(String.valueOf(profile.maxY));
        this.addDrawableChild(this.maxYField);
        
        // Single Y field
        this.singleYField = new TextFieldWidget(
            this.textRenderer, centerX - 150, startY + spacing * 4,
            300, 20, Text.literal("Single Y")
        );
        this.singleYField.setText(String.valueOf(profile.minY));
        this.addDrawableChild(this.singleYField);
        
        // Radius field (for radius mode)
        this.radiusField = new TextFieldWidget(
            this.textRenderer, centerX - 150, startY + spacing * 5,
            300, 20, Text.literal("Radius (0-32)")
        );
        this.radiusField.setText(String.valueOf(profile.scanRadius));
        this.radiusField.setPlaceholder(Text.literal("0=player's chunk only"));
        this.addDrawableChild(this.radiusField);
        
        // Chunks field (for chunks mode)
        this.chunksField = new TextFieldWidget(
            this.textRenderer, centerX - 150, startY + spacing * 5,
            300, 20, Text.literal("Chunks (1-1024)")
        );
        this.chunksField.setText(String.valueOf(profile.targetChunks));
        this.chunksField.setPlaceholder(Text.literal("Exact number of chunks to scan"));
        this.addDrawableChild(this.chunksField);
        
        // Block selection button
        this.blockSelectionButton = ButtonWidget.builder(
            Text.literal("§6Select Blocks (" + profile.targetBlocks.size() + ")"),
            button -> {
                if (this.client != null) {
                    this.client.setScreen(new BlockSelectionScreen(AdvancedScanner.getCurrentProfile()));
                }
            }
        ).dimensions(centerX - 150, startY + spacing * 6, 145, 20).build();
        this.addDrawableChild(this.blockSelectionButton);
        
        // ESP Settings button
        this.espSettingsButton = ButtonWidget.builder(
            Text.literal("§6ESP Settings"),
            button -> {
                if (this.client != null) {
                    this.client.setScreen(new EspConfigScreen());
                }
            }
        ).dimensions(centerX + 5, startY + spacing * 6, 145, 20).build();
        this.addDrawableChild(this.espSettingsButton);
        
        // Quick toggle buttons
        this.autoToggleButton = ButtonWidget.builder(
            Text.literal("Auto-scan: " + (AdvancedConfig.get().autoScan ? "§aON" : "§cOFF")),
            button -> {
                AdvancedConfig config = AdvancedConfig.get();
                config.autoScan = !config.autoScan;
                AdvancedConfig.save();
                updateToggleButtons();
                if (this.client != null && this.client.player != null) {
                    String status = config.autoScan ? "§aENABLED" : "§cDISABLED";
                    this.client.player.sendMessage(Text.literal("§6[Neoporium] Auto-scan: " + status), false);
                }
            }
        ).dimensions(centerX - 150, startY + spacing * 7, 145, 20).build();
        this.addDrawableChild(this.autoToggleButton);
        
        this.espToggleButton = ButtonWidget.builder(
            Text.literal("ESP: " + (WallRayRenderer.isESPEnabled() ? "§aON" : "§cOFF")),
            button -> {
                WallRayRenderer.toggleESP();
                updateToggleButtons();
            }
        ).dimensions(centerX + 5, startY + spacing * 7, 145, 20).build();
        this.addDrawableChild(this.espToggleButton);
        
        // Quick actions
        this.quickScanButton = ButtonWidget.builder(
            Text.literal("§aQuick Scan Now"),
            button -> {
                saveConfig();
                if (this.client != null && this.client.player != null && this.client.world != null) {
                    this.client.player.sendMessage(Text.literal("§6[Neoporium] Scanning..."), false);
                    AdvancedScanner.scanArea(this.client.world, this.client.player);
                    updateESPAfterScan();
                }
            }
        ).dimensions(centerX - 150, startY + spacing * 8, 145, 20).build();
        this.addDrawableChild(this.quickScanButton);
        
        this.clearResultsButton = ButtonWidget.builder(
            Text.literal("§cClear Results"),
            button -> {
                AdvancedScanner.clearScanResults();
                if (this.client != null && this.client.player != null) {
                    this.client.player.sendMessage(Text.literal("§6[Neoporium] Scan results cleared"), false);
                }
                updateESPDisplay();
            }
        ).dimensions(centerX + 5, startY + spacing * 8, 145, 20).build();
        this.addDrawableChild(this.clearResultsButton);
        
        // Test ESP button
        this.addDrawableChild(ButtonWidget.builder(
            Text.literal("§eTest ESP Now"),
            button -> {
                if (this.client != null && this.client.player != null) {
                    WallRayRenderer.testESP();
                }
            }
        ).dimensions(centerX - 150, startY + spacing * 9, 145, 20).build());
        
        // Force ESP refresh button
        this.addDrawableChild(ButtonWidget.builder(
            Text.literal("§6Refresh ESP"),
            button -> {
                if (this.client != null && this.client.player != null) {
                    Map<String, List<net.minecraft.util.math.BlockPos>> foundBlocks = AdvancedScanner.getFoundBlocks();
                    
                    if (!foundBlocks.isEmpty()) {
                        int totalBlocks = foundBlocks.values().stream().mapToInt(List::size).sum();
                        System.out.println("[Neoporium] GUI: Refreshing ESP with " + totalBlocks + " blocks (" + foundBlocks.size() + " types)");
                        
                        WallRayRenderer.updateHighlightsFromAdvanced(foundBlocks);
                        
                        this.client.player.sendMessage(
                            Text.literal("§6[Neoporium] ESP refreshed with §e" + totalBlocks + "§6 blocks"),
                            false
                        );
                    } else {
                        System.out.println("[Neoporium] GUI: No blocks found to refresh ESP");
                        this.client.player.sendMessage(
                            Text.literal("§7[Neoporium] No scan results to display in ESP"),
                            false
                        );
                    }
                }
            }
        ).dimensions(centerX + 5, startY + spacing * 9, 145, 20).build());
        
        // Save and close
        this.saveButton = ButtonWidget.builder(
            Text.literal("§aSave & Close"),
            button -> {
                saveConfig();
                this.close();
            }
        ).dimensions(centerX - 150, this.height - 30, 300, 20).build();
        this.addDrawableChild(this.saveButton);
        
        updateFieldVisibility();
        updateToggleButtons();
        updateESPDisplay();
    }
    
    private void updateFields() {
        AdvancedScanner.ScanProfile profile = AdvancedScanner.getCurrentProfile();
        useYRange = profile.useYRange;
        minYField.setText(String.valueOf(profile.minY));
        maxYField.setText(String.valueOf(profile.maxY));
        singleYField.setText(String.valueOf(profile.minY));
        radiusField.setText(String.valueOf(profile.scanRadius));
        chunksField.setText(String.valueOf(profile.targetChunks));
        scanModeSelector.setValue(profile.useChunksMode);
        updateFieldVisibility();
        updateBlockSelectionButton();
        updateToggleButtons();
    }
    
    private void updateFieldVisibility() {
        AdvancedScanner.ScanProfile profile = AdvancedScanner.getCurrentProfile();
        boolean useChunksMode = profile.useChunksMode;
        
        minYField.visible = useYRange;
        maxYField.visible = useYRange;
        singleYField.visible = !useYRange;
        
        radiusField.visible = !useChunksMode;
        chunksField.visible = useChunksMode;
    }
    
    private void updateBlockSelectionButton() {
        AdvancedScanner.ScanProfile profile = AdvancedScanner.getCurrentProfile();
        if (blockSelectionButton != null) {
            blockSelectionButton.setMessage(Text.literal("§6Select Blocks (" + profile.targetBlocks.size() + ")"));
        }
    }
    
    private void updateToggleButtons() {
        if (autoToggleButton != null) {
            autoToggleButton.setMessage(Text.literal("Auto-scan: " + (AdvancedConfig.get().autoScan ? "§aON" : "§cOFF")));
        }
        if (espToggleButton != null) {
            espToggleButton.setMessage(Text.literal("ESP: " + (WallRayRenderer.isESPEnabled() ? "§aON" : "§cOFF")));
        }
    }
    
    private void updateESPAfterScan() {
        new Thread(() -> {
            try {
                Thread.sleep(500);
                if (this.client != null) {
                    this.client.execute(() -> {
                        updateESPDisplay();
                    });
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
    }
    
    private void updateESPDisplay() {
        // This method will be called to update ESP-related UI elements
        // Currently handled in render() method
    }
    
    private void saveConfig() {
        try {
            AdvancedScanner.ScanProfile profile = AdvancedScanner.getCurrentProfile();
            
            profile.useYRange = useYRange;
            if (useYRange) {
                profile.minY = Integer.parseInt(minYField.getText());
                profile.maxY = Integer.parseInt(maxYField.getText());
            } else {
                int y = Integer.parseInt(singleYField.getText());
                profile.minY = y;
                profile.maxY = y;
            }
            
            profile.useChunksMode = scanModeSelector.getValue();
            
            if (profile.useChunksMode) {
                int chunks = Integer.parseInt(chunksField.getText());
                profile.targetChunks = Math.max(1, Math.min(1024, chunks));
            } else {
                int radius = Integer.parseInt(radiusField.getText());
                profile.scanRadius = Math.max(0, Math.min(32, radius));
            }
            
            AdvancedConfig.save();
            
            if (this.client != null && this.client.player != null) {
                String rangeText = useYRange ? 
                    profile.minY + " to " + profile.maxY : 
                    "Y=" + profile.minY;
                    
                String modeText;
                if (profile.useChunksMode) {
                    modeText = "chunks mode (" + profile.targetChunks + " chunks)";
                } else {
                    if (profile.scanRadius == 0) {
                        modeText = "player's chunk only";
                    } else {
                        int chunks = (profile.scanRadius * 2 + 1) * (profile.scanRadius * 2 + 1);
                        modeText = "radius " + profile.scanRadius + " (" + chunks + " chunks)";
                    }
                }
                
                this.client.player.sendMessage(Text.literal(
                    String.format("§a[Neoporium] Config saved: §e%s§a, Y: §e%s§a, Profile: §e%s",
                        modeText, rangeText, profile.name)
                ), false);
            }
            
        } catch (NumberFormatException e) {
            if (this.client != null && this.client.player != null) {
                this.client.player.sendMessage(Text.literal("§c[Neoporium] Invalid number format! Using defaults."), false);
                
                AdvancedScanner.ScanProfile profile = AdvancedScanner.getCurrentProfile();
                if (useYRange) {
                    minYField.setText(String.valueOf(profile.minY));
                    maxYField.setText(String.valueOf(profile.maxY));
                } else {
                    singleYField.setText(String.valueOf(profile.minY));
                }
                radiusField.setText(String.valueOf(profile.scanRadius));
                chunksField.setText(String.valueOf(profile.targetChunks));
            }
        }
    }
    
    @Override
    public void render(DrawContext context, int mouseX, int mouseY, float delta) {
        this.renderBackground(context, mouseX, mouseY, delta);
        
        context.drawCenteredTextWithShadow(this.textRenderer, "§6§lAdvanced Neoporium Scanner", 
            this.width / 2, 15, 0xFFFFFF);
        
        int startY = 40;
        int spacing = 25;
        
        if (useYRange) {
            context.drawTextWithShadow(this.textRenderer, "Min Y (-64 to 320)", 
                this.width / 2 - 150, startY + spacing * 3 - 10, 0xAAAAAA);
            context.drawTextWithShadow(this.textRenderer, "Max Y (-64 to 320)", 
                this.width / 2 + 5, startY + spacing * 3 - 10, 0xAAAAAA);
        } else {
            context.drawTextWithShadow(this.textRenderer, "Single Y Level (-64 to 320)", 
                this.width / 2 - 150, startY + spacing * 4 - 10, 0xAAAAAA);
        }
        
        AdvancedScanner.ScanProfile profile = AdvancedScanner.getCurrentProfile();
        if (profile.useChunksMode) {
            context.drawTextWithShadow(this.textRenderer, "Target Chunks (1-1024)", 
                this.width / 2 - 150, startY + spacing * 5 - 10, 0xAAAAAA);
        } else {
            context.drawTextWithShadow(this.textRenderer, "Radius (0-32 chunks, 0=player's chunk only)", 
                this.width / 2 - 150, startY + spacing * 5 - 10, 0xAAAAAA);
        }
        
        String blockCountText = profile.targetBlocks.size() + " block" + (profile.targetBlocks.size() != 1 ? "s" : "");
        
        context.drawTextWithShadow(this.textRenderer, 
            "§eProfile: §f" + profile.name + " §7| §eBlocks: §f" + blockCountText,
            this.width / 2 - 150, startY + spacing * 10 + 5, 0xFFFFFF);
        
        int espHighlightCount = WallRayRenderer.getHighlightCount();
        Map<String, List<net.minecraft.util.math.BlockPos>> foundBlocks = AdvancedScanner.getFoundBlocks();
        int totalFoundBlocks = foundBlocks.values().stream().mapToInt(List::size).sum();
        
        String espStatus = WallRayRenderer.isESPEnabled() ? "§aON" : "§cOFF";
        
        if (espHighlightCount > 0) {
            context.drawTextWithShadow(this.textRenderer, 
                "§aESP: " + espStatus + " §7| §aShowing: §e" + espHighlightCount + "§a/" + totalFoundBlocks + " blocks",
                this.width / 2 - 150, startY + spacing * 11 + 5, 0xFFFFFF);
            
            if (!foundBlocks.isEmpty()) {
                String typesText = foundBlocks.keySet().toString();
                if (typesText.length() > 40) {
                    typesText = typesText.substring(0, 37) + "...";
                }
                context.drawTextWithShadow(this.textRenderer, 
                    "§7Block types: §f" + typesText,
                    this.width / 2 - 150, startY + spacing * 12 + 5, 0xAAAAAA);
            }
        } else {
            context.drawTextWithShadow(this.textRenderer, 
                "§7ESP: " + espStatus + " §7| No blocks highlighted",
                this.width / 2 - 150, startY + spacing * 11 + 5, 0xAAAAAA);
            
            if (totalFoundBlocks > 0) {
                context.drawTextWithShadow(this.textRenderer, 
                    "§7Found §e" + totalFoundBlocks + "§7 blocks (use Refresh ESP button)",
                    this.width / 2 - 150, startY + spacing * 12 + 5, 0xAAAAAA);
            }
        }
        
        if (profile.useChunksMode) {
            context.drawTextWithShadow(this.textRenderer, 
                "§7Mode: §fChunks Mode §7| §f" + profile.targetChunks + "§7 chunks will be scanned",
                this.width / 2 - 150, startY + spacing * 13 + 5, 0xAAAAAA);
        } else {
            if (profile.scanRadius == 0) {
                context.drawTextWithShadow(this.textRenderer, 
                    "§7Mode: §fRadius Mode §7| §fPlayer's chunk only (1 chunk)",
                    this.width / 2 - 150, startY + spacing * 13 + 5, 0xAAAAAA);
            } else {
                int chunks = (profile.scanRadius * 2 + 1) * (profile.scanRadius * 2 + 1);
                context.drawTextWithShadow(this.textRenderer, 
                    "§7Mode: §fRadius Mode §7| §f" + chunks + "§7 chunks in " + (profile.scanRadius * 2 + 1) + "x" + (profile.scanRadius * 2 + 1) + " area",
                    this.width / 2 - 150, startY + spacing * 13 + 5, 0xAAAAAA);
            }
        }
        
        context.drawTextWithShadow(this.textRenderer, 
            "§7Keybinds: §6B§7=Scan, §6G§7=GUI, §6H§7=ESP, §6P§7=Cycle Profile",
            this.width / 2 - 150, this.height - 50, 0xAAAAAA);
        
        super.render(context, mouseX, mouseY, delta);
    }
    
    @Override
    public void tick() {
        super.tick();
        updateBlockSelectionButton();
    }
    
    @Override
    public void close() {
        saveConfig();
        super.close();
    }
